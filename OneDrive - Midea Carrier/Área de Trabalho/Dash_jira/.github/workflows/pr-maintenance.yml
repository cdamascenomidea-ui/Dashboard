name: PR maintenance

on:
  schedule:
    - cron: '0 8 * * *' # daily at 08:00 UTC
  workflow_dispatch:

jobs:
  remind:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    steps:
      - name: Remind about untriaged PRs
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const minDays = parseInt(process.env.MIN_DAYS || '1', 10);
            const threshold = Date.now() - minDays * 24 * 60 * 60 * 1000;
            const marker = '**[PR Maintenance]**';

            const prs = await github.paginate(github.pulls.list, { owner, repo, state:'open', per_page: 100 });
            for (const pr of prs) {
              const updatedAt = new Date(pr.updated_at).getTime();
              if (updatedAt > threshold) continue;

              const hasReviewers = (pr.requested_reviewers && pr.requested_reviewers.length>0) || (pr.requested_teams && pr.requested_teams.length>0);
              const hasAssignees = pr.assignees && pr.assignees.length>0;
              const hasLabels = pr.labels && pr.labels.length>0;

              if (hasReviewers && hasAssignees && hasLabels) continue;

              // Avoid duplicate reminders
              const comments = await github.issues.listComments({ owner, repo, issue_number: pr.number, per_page: 100 });
              if (comments.data.some(c => c.body && c.body.includes(marker))) continue;

              const missing = [];
              if (!hasReviewers) missing.push('reviewers');
              if (!hasAssignees) missing.push('assignees');
              if (!hasLabels) missing.push('labels');

              const body = `${marker}\nHello! This PR has been open for more than ${minDays} day(s) and is missing: **${missing.join(', ')}**.\n\nMaintainers: please consider adding reviewers/assignees/labels or advise next steps.\n\nThank you!`;

              await github.issues.createComment({ owner, repo, issue_number: pr.number, body });
            }
        env:
          MIN_DAYS: '1'
